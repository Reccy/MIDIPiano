version: 2.1

orbs:
    win: circleci/windows@2.3.0

jobs:
    build:
        executor: win/default
        steps:
            - checkout
            - run:
                name: Add CMake to Path
                command: |
                    SET CMAKE_EXEC_PATH="$Env:ProgramFiles\CMake\bin\cmake.exe"
                    SET PATH=$CMAKE_EXEC_PATH;%PATH%
            - restore_cache:
                key: -cmake-v1-{{ (Get-Filehash $CMAKE_EXEC_PATH).Hash }}
            - run:
                name: Download CMake
                command: |
                    $ProgressPreference = "SilentlyContinue"
                    Invoke-WebRequest -URI https://github.com/Kitware/CMake/releases/download/v3.16.4/cmake-3.16.4-win64-x64.zip -OutFile $Env:HOMEPATH\cmake-3.16.4-win64-x64.zip
                    Expand-Archive $Env:HOMEPATH\cmake-3.16.4-win64-x64.zip -DestinationPath "$Env:ProgramFiles"
                    Rename-Item "$Env:ProgramFiles\cmake-3.16.4-win64-x64" -NewName CMake
            - save_cache:
                key: -cmake-v1-{{ (Get-Filehash $CMAKE_EXEC_PATH).Hash }}
                paths:
                    - "$Env:ProgramFiles\\CMake"
            - run:
                name: Creating build directory
                command: mkdir build
            - run:
                name: Generating build system with CMake
                command: cmake ..
                working_directory: build
            - run:
                name: Building project in Release configuration
                command: cmake --build . --config Release
                working_directory: build
            - persist_to_workspace:
                root: build
                paths:
                    - Release
    test:
        executor: win/default
        steps:
            - attach_workspace:
                at: build
            - run:
                name: Executing Test Runner
                command: ./MidiPianoTestRunner.exe
                working_directory: build/Release
    deploy:
        docker:
            - image: cibuilds/github:0.10
        steps:
            - checkout
            - attach_workspace:
                at: build
            - run:
                name: Add execute flag to generate_release_tag.sh
                command: chmod +x ./generate_release_tag.sh
                working_directory: .circleci
            - run:
                name: Publish Release on GitHub
                command: |
                    VERSION=$(.circleci/generate_release_tag.sh)
                    ghr -t "${GITHUB_TOKEN}" \
                    -u "${CIRCLE_PROJECT_USERNAME}" \
                    -r "${CIRCLE_PROJECT_REPONAME}" \
                    -c "${CIRCLE_SHA1}" \
                    -delete "${VERSION}" \
                    ./build/Release

workflows:
    version: 2.1
    build_and_test_and_deploy:
        jobs:
            - build
            - test:
                requires:
                    - build
            - deploy:
                requires:
                    - test
                filters:
                    branches:
                        only: /release\/(\d+)\.(\d+)$/ # release/MAJOR.MINOR   e.g. release/1.0
